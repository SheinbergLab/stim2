name: Release for Linux

on:
  push:
    tags:
      - '*'

jobs:

  release:

    strategy:
      matrix:
        include:
          # Debian 12 (Bookworm) - FFmpeg 5.x / libav 59
          - runner: ubuntu-22.04
            container: debian:12
            distro: bookworm
            arch: amd64
          - runner: ubuntu-22.04-arm
            container: debian:12
            distro: bookworm
            arch: arm64
          # Debian 13 (Trixie) - FFmpeg 7.x / libav 61
          - runner: ubuntu-22.04
            container: debian:13
            distro: trixie
            arch: amd64
          - runner: ubuntu-22.04-arm
            container: debian:13
            distro: trixie
            arch: arm64

    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}

    permissions:
      contents: write

    steps:

      - name: Install build tools and dependencies
        run: |
          apt update
          apt install -y sudo wget git ca-certificates
          
          sudo apt update
          sudo apt install -y build-essential cmake pkg-config cmake-data
          sudo apt install -y zlib1g-dev
          sudo apt install -y libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libxext-dev libwayland-dev libxkbcommon-dev
          sudo apt install -y libglew-dev libglm-dev
          sudo apt install -y libopenal-dev libfreetype-dev
          sudo apt install -y libavformat-dev libavcodec-dev libavutil-dev libswscale-dev libswresample-dev

      - name: Check out our stim2 code for the current tag
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install TCL 9 to the build environment
        run: |
          cd deps/tcl/unix/
          ./configure
          make
          sudo make install

      - name: Install GLFW static lib into the build environment
        run: |
          cd deps/glfw/
          cmake -B build-full-static -D GLFW_BUILD_WAYLAND=ON -D GLFW_BUILD_X11=ON
          cmake --build build-full-static --parallel
          sudo cmake --install build-full-static

      - name: Install spine-c static lib into the build environment
        run: |
          cd deps/spine-runtimes/spine-c/
          cmake -B build -D CMAKE_POSITION_INDEPENDENT_CODE=ON
          cmake --build build --parallel
          cmake --install build --prefix ./build
          sudo mkdir -p /usr/local/include/spine/
          sudo cp ./build/dist/include/*.h /usr/local/include/spine/
          sudo cp ./build/dist/lib/*.a /usr/local/lib

      - name: Install box2d v3 static lib into the build environment
        run: |
          cd deps/box2d
          mkdir build
          cmake -B build -D BOX2D_UNIT_TESTS=OFF -D BOX2D_SAMPLES=OFF -D BOX2D_BENCHMARKS=OFF -D BUILD_SHARED_LIBS=OFF
          cmake --build build --parallel
          sudo cmake --install build

      - name: Install our dg and dlsh libs and headers into the build environment
        run: |
          DLSH_VERSION=0.0.48
          wget https://github.com/benjamin-heasly/dlsh/releases/download/${DLSH_VERSION}/dlsh-dg_${DLSH_VERSION}_${{ matrix.arch }}.deb
          wget https://github.com/benjamin-heasly/dlsh/releases/download/${DLSH_VERSION}/dlsh-dlsh_${DLSH_VERSION}_${{ matrix.arch }}.deb
          sudo dpkg --install dlsh-dg_${DLSH_VERSION}_${{ matrix.arch }}.deb
          sudo dpkg --install dlsh-dlsh_${DLSH_VERSION}_${{ matrix.arch }}.deb

      - name: Verify FFmpeg version
        run: |
          echo "Building for ${{ matrix.distro }} (${{ matrix.arch }})"
          echo "FFmpeg versions:"
          pkg-config --modversion libavformat
          pkg-config --modversion libavcodec

      - name: Build stim2 stimdlls
        run: |
          cd stimdlls/
          cmake -D PROJECT_VERSION=${{ github.ref_name }} -B build
          cmake --build build --parallel

      - name: Build stim2 and package for release
        run: |
          cmake -D PROJECT_VERSION=${{ github.ref_name }} -D DISTRO_SUFFIX=${{ matrix.distro }} -B build
          cmake --build build --parallel
          cpack -G DEB --config build/CPackConfig.cmake
          ls -la stim2*.deb

      - name: Upload release artifacts
        uses: ncipollo/release-action@v1
        with:
          artifacts: ./stim2*.deb
          body: stim2 version ${{ github.ref_name }}
          generateReleaseNotes: true
          allowUpdates: true

  check:

    needs: release

    strategy:
      matrix:
        include:
          # Test Bookworm packages on Debian 12
          - runner: ubuntu-22.04
            container: debian:12
            distro: bookworm
            arch: amd64
          - runner: ubuntu-22.04-arm
            container: debian:12
            distro: bookworm
            arch: arm64
          # Test Trixie packages on Debian 13
          - runner: ubuntu-22.04
            container: debian:13
            distro: trixie
            arch: amd64
          - runner: ubuntu-22.04-arm
            container: debian:13
            distro: trixie
            arch: arm64

    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}

    steps:

      - name: Install runtime dependencies
        run: |
          apt update
          apt install -y sudo wget ca-certificates git
          sudo apt install -y libavformat59 libavcodec59 libswscale6 libswresample4 || true
          sudo apt install -y libavformat61 libavcodec61 libswscale8 libswresample5 || true
          sudo apt install -y libglew2.2 libfreetype6 libopenal1

      - name: Check out our stim2 code for the current tag
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install TCL 9 to the check environment
        run: |
          cd deps/tcl/unix/
          ./configure
          make
          sudo make install

      - name: Install the package we just released
        run: |
          wget ${{ github.server_url }}/${{ github.repository }}/releases/download/${{ github.ref_name }}/stim2_${{ github.ref_name }}_${{ matrix.arch }}_${{ matrix.distro }}.deb
          sudo apt install --yes ./stim2_${{ github.ref_name }}_${{ matrix.arch }}_${{ matrix.distro }}.deb

      - name: Sanity check the installed package
        run: |
          /usr/local/stim2/stim2 --help