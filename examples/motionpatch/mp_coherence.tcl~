# examples/motionpatch/mp_coherence.tcl
# Motion Coherence Demonstration
# Demonstrates: random dot kinematogram, coherence levels, direction control
#
# Classic psychophysics stimulus - a field of moving dots where
# a fraction (coherence) move in the same direction while others
# move randomly. Used extensively in motion perception research.

# ============================================================
# STIM CODE
# ============================================================

proc mp_coherence_setup {nDots speed lifetime} {
    glistInit 1
    resetObjList
    
    # Create motionpatch: n dots, speed (deg/sec), lifetime (frames)
    set mp [motionpatch $nDots $speed $lifetime]
    objName $mp dots
    
    # Set initial appearance
    motionpatch_pointsize $mp 4.0
    motionpatch_color $mp 0.9 0.9 0.9 1.0
    motionpatch_masktype $mp 1           ;# circular aperture
    motionpatch_coherence $mp 0.5
    motionpatch_direction $mp 0.0        ;# rightward
    motionpatch_speed $mp $speed
    
    # Wrap in metagroup for positioning/scaling
    set mg [metagroup]
    metagroupAdd $mg $mp
    objName $mg patch
    scaleObj $mg 6.0 6.0
    
    glistAddObject $mg 0
    glistSetDynamic 0 1
    glistSetCurGroup 0
    glistSetVisible 1
    redraw
}

# ---- Adjuster helper procs ----

proc mp_set_motion {name coherence direction speed} {
    motionpatch_coherence $name $coherence
    motionpatch_direction $name [expr {$direction * 3.14159265 / 180.0}]
    motionpatch_speed $name $speed
}

proc mp_get_motion {name} {
    dict create coherence 0.5 direction 0 speed 0.005
}

proc mp_set_appearance {name pointsize r g b} {
    motionpatch_pointsize $name $pointsize
    motionpatch_color $name $r $g $b 1.0
}

proc mp_get_appearance {name} {
    dict create pointsize 4.0 r 0.9 g 0.9 b 0.9
}

# ============================================================
# WORKSPACE DEMO INTERFACE
# ============================================================
workspace::reset

# Main setup - these params require re-running setup
workspace::setup mp_coherence_setup {
    nDots    {int 50 2000 50 500 "Number of Dots"}
    speed    {float 0.001 0.05 0.001 0.005 "Base Speed"}
    lifetime {int 5 100 5 30 "Dot Lifetime (frames)"}
} -adjusters {motion_params dot_appearance patch_transform} -label "Motion Coherence"

# Motion parameters adjuster
workspace::adjuster motion_params {
    coherence {float 0.0 1.0 0.05 0.5 "Coherence"}
    direction {float 0 360 15 0 "Direction (deg)"}
    speed     {float 0.001 0.05 0.001 0.005 "Speed"}
} -target dots -proc mp_set_motion -getter mp_get_motion -label "Motion Parameters"

# Dot appearance adjuster  
workspace::adjuster dot_appearance {
    pointsize {float 1.0 10.0 0.5 4.0 "Dot Size"}
    r {float 0.0 1.0 0.05 0.9 "Red"}
    g {float 0.0 1.0 0.05 0.9 "Green"}
    b {float 0.0 1.0 0.05 0.9 "Blue"}
} -target dots -proc mp_set_appearance -getter mp_get_appearance -label "Dot Appearance"

# Transform adjuster for the metagroup
workspace::adjuster patch_transform -template scale -target patch -label "Patch Size"
