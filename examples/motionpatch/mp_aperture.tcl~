# examples/motionpatch/mp_aperture.tcl
# Aperture Types Demonstration
# Demonstrates: circular, rectangular, and hexagonal apertures
#
# Motion patches can be masked to different shapes - useful for
# presenting stimuli in specific regions or matching receptive fields.
# masktype: 0=none (square), 1=circle, 2=hexagon

# ============================================================
# STIM CODE
# ============================================================

proc mp_aperture_setup {nDots masktype} {
    glistInit 1
    resetObjList
    
    set mp [motionpatch $nDots 0.01 30]
    objName $mp dots
    
    motionpatch_pointsize $mp 4.0
    motionpatch_color $mp 0.9 0.9 0.9 1.0
    motionpatch_masktype $mp $masktype
    motionpatch_coherence $mp 1.0
    motionpatch_direction $mp 0.0
    motionpatch_speed $mp 0.005
    
    set mg [metagroup]
    metagroupAdd $mg $mp
    objName $mg patch
    scaleObj $mg 6.0 6.0
    
    glistAddObject $mg 0
    glistSetDynamic 0 1
    glistSetCurGroup 0
    glistSetVisible 1
    redraw
}

# ---- Adjuster helper procs ----

proc mp_ap_set_motion {name coherence direction speed} {
    motionpatch_coherence $name $coherence
    motionpatch_direction $name [expr {$direction * 3.14159265 / 180.0}]
    motionpatch_speed $name $speed
}

proc mp_ap_get_motion {name} {
    dict create coherence 1.0 direction 0 speed 0.005
}

proc mp_ap_set_pointsize {name pointsize} {
    motionpatch_pointsize $name $pointsize
}

proc mp_ap_get_pointsize {name} {
    dict create pointsize 4.0
}

proc mp_ap_set_color {name r g b} {
    motionpatch_color $name $r $g $b 1.0
}

proc mp_ap_get_color {name} {
    dict create r 0.9 g 0.9 b 0.9
}

# ============================================================
# WORKSPACE DEMO INTERFACE
# ============================================================
workspace::reset

# Main setup - nDots and masktype require recreation
workspace::setup mp_aperture_setup {
    nDots    {int 50 2000 50 500 "Number of Dots"}
    masktype {int 0 2 1 1 "Mask Type (0=none, 1=circle, 2=hex)"}
} -adjusters {ap_motion ap_pointsize ap_color ap_transform} \
  -label "Aperture Types"

# Variants for quick selection
workspace::variant ap_none {nDots 500 masktype 0} \
  -adjusters {ap_motion ap_pointsize ap_color ap_transform} \
  -label "No Mask (Square)"

workspace::variant ap_circle {nDots 500 masktype 1} \
  -adjusters {ap_motion ap_pointsize ap_color ap_transform} \
  -label "Circle"

workspace::variant ap_hexagon {nDots 500 masktype 2} \
  -adjusters {ap_motion ap_pointsize ap_color ap_transform} \
  -label "Hexagon"

# Adjusters
workspace::adjuster ap_motion {
    coherence {float 0.0 1.0 0.05 1.0 "Coherence"}
    direction {float 0 360 15 0 "Direction (deg)"}
    speed     {float 0.0 0.01 0.0005 0.005 "Speed"}
} -target dots -proc mp_ap_set_motion -getter mp_ap_get_motion \
  -label "Motion"

workspace::adjuster ap_pointsize {
    pointsize {float 1.0 10.0 0.5 4.0 "Dot Size"}
} -target dots -proc mp_ap_set_pointsize -getter mp_ap_get_pointsize \
  -label "Dot Size"

workspace::adjuster ap_color {
    r {float 0.0 1.0 0.05 0.9 "Red"}
    g {float 0.0 1.0 0.05 0.9 "Green"}
    b {float 0.0 1.0 0.05 0.9 "Blue"}
} -target dots -proc mp_ap_set_color -getter mp_ap_get_color \
  -label "Dot Color"

workspace::adjuster ap_transform -template scale -target patch \
  -label "Patch Size"
